<!DOCTYPE html>
<html lang="ko">
<<<<<<< HEAD
<head>
<meta charset="UTF-8">
<title>ê²°ì œ ì„±ê³µ</title>
<style>
body {
	background-color: #e9f1ff;
	font-family: Arial, sans-serif;
	text-align: center;
	padding-top: 50px;
}

.wrapper {
	background-color: #fff;
	border-radius: 12px;
	box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
	width: 450px;
	padding: 30px;
	margin: auto;
}

h2 {
	color: #3182f6;
	margin-top: 20px;
}

.success-icon {
	width: 80px;
	margin-top: 10px;
}

.info-box {
	text-align: left;
	margin-top: 20px;
	padding: 10px;
}

.info-box div {
	display: flex;
	justify-content: space-between;
	padding: 5px 0;
}

.button-container {
	display: flex;
	justify-content: center;
	margin-top: 20px;
}

.button {
	padding: 10px;
	border: none;
	width: 50%;
	cursor: pointer;
	border-radius: 6px;
	font-size: 14px;
}

.btn-primary {
	background-color: #3182f6;
	color: white;
}
</style>
</head>
<body>

	<div class="wrapper">
		<img class="success-icon"
			src="https://static.toss.im/illusts/check-blue-spot-ending-frame.png" />
		<h2>ê²°ì œë¥¼ ì™„ë£Œí–ˆì–´ìš”</h2>

		<div class="info-box">
			<div>
				<b>ê²°ì œê¸ˆì•¡</b> <span id="amount">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</span>
			</div>
			<div>
				<b>ì£¼ë¬¸ë²ˆí˜¸</b> <span id="orderId">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</span>
			</div>
			<div>
				<b>ê²°ì œí‚¤</b> <span id="paymentKey">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</span>
			</div>
		</div>

		<div class="button-container">
			<button class="button btn-primary" onclick="location.href='/main'">ë©”ì¸ìœ¼ë¡œ</button>
		</div>
	</div>

	<script>
		const urlParams = new URLSearchParams(window.location.search);
		const orderId = urlParams.get("orderId");
		const paymentKey = urlParams.get("paymentKey");
		let bookingId = null; // âœ… bookingId ì €ì¥í•  ë³€ìˆ˜

		// âœ… bookingId ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜ (orderId â†’ bookingId ë³€í™˜)
		async function getBookingId() {
			if (!orderId) {
				console.error("âŒ orderIdê°€ ì—†ìŠµë‹ˆë‹¤.");
				return;
			}

			try {
				console.log("ğŸ“Œ ì„œë²„ì— orderId ìš”ì²­: ", orderId);
				const response = await fetch(`/api/booking/bookingId?orderId=${orderId}`);
				if (!response.ok) throw new Error("bookingIdë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");

				const data = await response.json();
				if (!data.bookingId || data.bookingId === 0) throw new Error("ì˜¬ë°”ë¥¸ bookingIdê°€ ì—†ìŠµë‹ˆë‹¤.");

				bookingId = data.bookingId;
				console.log("âœ… ê°€ì ¸ì˜¨ bookingId:", bookingId);
				await fetchPrice();  // âœ… bookingIdë¥¼ ê°€ì ¸ì˜¨ í›„ ê²°ì œ ê¸ˆì•¡ ì¡°íšŒ ì‹¤í–‰
			} catch (error) {
				console.error("âŒ bookingId ë¡œë”© ì‹¤íŒ¨:", error);
				document.getElementById("amount").textContent = "ì˜¤ë¥˜";
			}
		}

		// âœ… ê²°ì œëœ ì˜ˆì•½ì˜ ê°€ê²©ì„ ì„œë²„ì—ì„œ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
		async function fetchPrice() {
			if (!bookingId) {
				console.error("âŒ bookingIdê°€ ì—†ìŠµë‹ˆë‹¤.");
				return;
			}

			try {
				console.log("ğŸ“Œ ì„œë²„ì— bookingId ìš”ì²­: ", bookingId);
				const response = await fetch(`/api/booking/price?bookingId=${bookingId}`);
				if (!response.ok) throw new Error("ê²°ì œ ê¸ˆì•¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");

				const data = await response.json();
				if (!data.price || isNaN(data.price)) {
					throw new Error("ì„œë²„ì—ì„œ ì˜¬ë°”ë¥¸ ê°€ê²© ë°ì´í„°ë¥¼ ë°˜í™˜í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
				}

				document.getElementById("amount").textContent = data.price.toLocaleString() + "ì›";
			} catch (error) {
				console.error("âŒ ê²°ì œ ê¸ˆì•¡ ë¡œë”© ì‹¤íŒ¨:", error);
				document.getElementById("amount").textContent = "ì˜¤ë¥˜";
			}
		}

		// âœ… ê²°ì œ í™•ì¸ í•¨ìˆ˜ (ê²°ì œ ì„±ê³µ ì—¬ë¶€ ì²´í¬)
		async function confirm() {
			const requestData = {
				paymentKey: paymentKey,
				orderId: orderId,
				amount: urlParams.get("amount"),
			};

			console.log("ğŸ” ê²°ì œ í™•ì¸ ìš”ì²­:", requestData);

			const response = await fetch("/confirm", {
				method: "POST",
				headers: {
					"Content-Type": "application/json",
				},
				body: JSON.stringify(requestData),
			});

			const json = await response.json();
			console.log("âœ… ê²°ì œ í™•ì¸ ì‘ë‹µ:", json);

			if (!response.ok || json.status !== "success") {
				console.error("âŒ ê²°ì œ ì‹¤íŒ¨:", json);
				window.location.href = `/fail.html?message=${json.message || 'ê²°ì œ ì‹¤íŒ¨'}&code=${json.code || 'ERROR'}`;
				return;
			}

			await getBookingId(); // âœ… ê²°ì œ ì„±ê³µ í›„ bookingId ì¡°íšŒ ë° ê°€ê²© ê°€ì ¸ì˜¤ê¸°
		}

		// âœ… í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
		confirm();

		document.getElementById("orderId").textContent = orderId || "ì •ë³´ ì—†ìŒ";
		document.getElementById("paymentKey").textContent = paymentKey || "ì •ë³´ ì—†ìŒ";
	</script>

</body>
=======
  <head>
    <meta charset="utf-8" />
    <link rel="icon" href="https://static.toss.im/icons/png/4x/icon-toss-logo.png" />
    <link rel="stylesheet" type="text/css" href="style.css" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>í† ìŠ¤í˜ì´ë¨¼ì¸  ìƒ˜í”Œ í”„ë¡œì íŠ¸</title>
  </head>

  <body>
    <div class="box_section" style="width: 600px">
      <img width="100px" src="https://static.toss.im/illusts/check-blue-spot-ending-frame.png" />
      <h2>ê²°ì œë¥¼ ì™„ë£Œí–ˆì–´ìš”</h2>

      <div class="p-grid typography--p" style="margin-top: 50px">
        <div class="p-grid-col text--left"><b>ê²°ì œê¸ˆì•¡</b></div>
        <div class="p-grid-col text--right" id="amount"></div>
      </div>
      <div class="p-grid typography--p" style="margin-top: 10px">
        <div class="p-grid-col text--left"><b>ì£¼ë¬¸ë²ˆí˜¸</b></div>
        <div class="p-grid-col text--right" id="orderId"></div>
      </div>
      <div class="p-grid typography--p" style="margin-top: 10px">
        <div class="p-grid-col text--left"><b>paymentKey</b></div>
        <div class="p-grid-col text--right" id="paymentKey" style="white-space: initial; width: 250px"></div>
      </div>
      <div class="p-grid" style="margin-top: 30px">
        <button class="button p-grid-col5" onclick="location.href='https://docs.tosspayments.com/guides/v2/payment-widget/integration';">ì—°ë™ ë¬¸ì„œ</button>
        <button class="button p-grid-col5" onclick="location.href='https://discord.gg/A4fRFXQhRu';" style="background-color: #e8f3ff; color: #1b64da">ì‹¤ì‹œê°„ ë¬¸ì˜</button>
      </div>
    </div>

    <div class="box_section" style="width: 600px; text-align: left">
      <b>Response Data :</b>
      <div id="response" style="white-space: initial"></div>
    </div>

    <script>
      // ì¿¼ë¦¬ íŒŒë¼ë¯¸í„° ê°’ì´ ê²°ì œ ìš”ì²­í•  ë•Œ ë³´ë‚¸ ë°ì´í„°ì™€ ë™ì¼í•œì§€ ë°˜ë“œì‹œ í™•ì¸í•˜ì„¸ìš”.
      // í´ë¼ì´ì–¸íŠ¸ì—ì„œ ê²°ì œ ê¸ˆì•¡ì„ ì¡°ì‘í•˜ëŠ” í–‰ìœ„ë¥¼ ë°©ì§€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
      const urlParams = new URLSearchParams(window.location.search);

      // ì„œë²„ë¡œ ê²°ì œ ìŠ¹ì¸ì— í•„ìš”í•œ ê²°ì œ ì •ë³´ë¥¼ ë³´ë‚´ì„¸ìš”.
      async function confirm() {
        var requestData = {
          paymentKey: urlParams.get("paymentKey"),
          orderId: urlParams.get("orderId"),
          amount: urlParams.get("amount"),
        };

        const response = await fetch("/confirm", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(requestData),
        });

        const json = await response.json();

        if (!response.ok) {
          // TODO: ê²°ì œ ì‹¤íŒ¨ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ êµ¬í˜„í•˜ì„¸ìš”.
          console.log(json);
          window.location.href = `/fail?message=${json.message}&code=${json.code}`;
        }

        // TODO: ê²°ì œ ì„±ê³µ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ êµ¬í˜„í•˜ì„¸ìš”.
        // console.log(json);
        return json;
      }
      confirm().then(function (data) {
        document.getElementById("response").innerHTML = `<pre>${JSON.stringify(data, null, 4)}</pre>`;
      });

      const paymentKeyElement = document.getElementById("paymentKey");
      const orderIdElement = document.getElementById("orderId");
      const amountElement = document.getElementById("amount");

      orderIdElement.textContent = urlParams.get("orderId");
      amountElement.textContent = urlParams.get("amount") + "ì›";
      paymentKeyElement.textContent = urlParams.get("paymentKey");
    </script>
  </body>
>>>>>>> 2617167 (first test)
</html>
