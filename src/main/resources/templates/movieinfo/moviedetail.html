<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>Insert title here</title>
<link rel="stylesheet" href="../css/bootstrap.min.css">
<style type="text/css">
#header-container {
	width: 100%;
	background-color: #ffffff;
	position: relative;
	z-index: 10;
}
footer-container {
	position: relative;
	width: 100%;
}
.tab-container {
    display: flex;
    justify-content: center;
    border-bottom: 2px solid #ddd;
    margin-top: 20px;
}
.tab {
    padding: 10px 20px;
    cursor: pointer;
    font-weight: bold;
    color: #666;
}
.tab.active {
    border-bottom: 2px solid black;
    color: black;
}
#tab-content {
    margin-top: 20px;
    padding: 10px;
}
.review-input {
    margin-bottom: 20px;
}

.review-item {
    display: flex;
    align-items: flex-start;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 1px solid #eee;
}

.review-profile {
    margin-right: 15px;
}

.review-profile img {
    width: 50px;
    height: 50px;
    border-radius: 50%;
}

.review-content {
    flex: 1;
}

.review-meta {
    font-size: 14px;
    color: #666;
    margin-bottom: 5px;
}

.review-text {
    font-size: 16px;
}

.review-like {
    font-size: 14px;
    color: #666;
    margin-left: 10px;
    align-self: center;
}

.content-box {
    width: 900px;
    margin: 0 auto;
}

.review-input-container {
    position: relative;
    width: 100%;
    border: 1px solid #ddd;
    border-radius: 5px;
    display: flex;
    align-items: center;
    overflow: hidden;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.review-input-container textarea {
    width: 100%;
    height: 80px;
    border: none;
    padding: 10px 120px 10px 10px;
    resize: none;
    outline: none;
    font-size: 15px;
}

.review-input-container button {
    position: absolute;
    right: 0;
    top: 0;
    width: 110px;
    height: 100%;
    border: none;
    background-color: #444;
    color: white;
    cursor: pointer;
    font-size: 15px;
    transition: background-color 0.2s ease;
}

.review-input-container button:hover {
    background-color: #333;
}

.char-count {
    position: absolute;
    bottom: 10px;
    right: 120px;
    color: #999;
    font-size: 13px;
}

</style>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>

	<!-- í—¤ë” -->
	<div id="header-container">
		<div th:replace="~{layouts/header}"></div>
	</div>

	<div class="container" align="center" style="margin-top:100px; padding-bottom:100px;">
		<table style="width: 900px; margin-left: auto; margin-right: auto;">
			<tr>
				<td rowspan="4" style="width:310px; padding-right:50px;">
					<img alt="ì´ë¯¸ì§€" th:src="|/movie_poster/${movie_info.poster1}|" width="300" height="400">
				</td>
				<td align="left" style="height:50px;">[[${movie_info.title}]]</td>
			</tr>
			<tr>
				<td style="height:20px;">[[${movie_info.title}]] | [[${movie_info.runningtime}]] | [[${movie_info.agerating}]] | [[${movie_info.total}]]</td>
			</tr>
			<tr>
				<td>
					<pre>[[${movie_info.synopsis}]]</pre>
				</td>
			</tr>
			<tr>
				<td style="height:50px;">
					<a href="#">ì˜ˆë§¤í•˜ê¸°</a>
				</td>
			</tr>
		</table>
	</div>

	<!-- ğŸ”¹ ìƒì„¸ì •ë³´ | ê´€ëŒí‰(0) íƒ­ -->
	<div class="tab-container">
	    <span class="tab active" id="detail-tab">ìƒì„¸ì •ë³´</span>
	    <span class="tab" id="review-tab">ê´€ëŒí‰ (<span id="review-count">0</span>)</span>
	</div>

	<div id="detail-section" class="content-box">
	<!-- ì´ê³³ì— Ajaxë¡œ ì˜í™”ì •ë³´ê°€ ë™ì ìœ¼ë¡œ ë“¤ì–´ì˜´ -->
	</div>

	<!-- ğŸ”¹ ë¦¬ë·° ì…ë ¥ & ëª©ë¡ -->
	<div id="tab-content" style="display: none;">

		
	    <div id="review-section" class="content-box">
	        <!-- ë¦¬ë·° ì…ë ¥ í¼ -->
	        <!-- ë¡œê·¸ì¸í•œ ì‚¬ìš©ìë§Œ ì…ë ¥ ê°€ëŠ¥ -->
			<div class="review-input" th:if="${sessionMemid != null}">
			    <div class="review-input-container">
			        <textarea id="comment" maxlength="330" placeholder="ê´€ëŒí‰ì„ ì‘ì„±í•´ì£¼ì„¸ìš”."></textarea>
			        <button id="submit-review-btn">ê´€ëŒí‰ ì‘ì„±</button>
			        <div class="char-count"><span id="char-count-num">0</span>/330</div>
			    </div>
			    <input type="number" id="rating" min="1" max="10" placeholder="ë³„ì  (1~10)" style="margin-top:10px;width:110px;">
			</div>
	
	        <!-- ë¹„ë¡œê·¸ì¸ ì‚¬ìš©ìì—ê²Œ ì•ˆë‚´ -->
	        <div class="review-input" th:if="${sessionMemid == null}">
	            <p>ë¦¬ë·°ë¥¼ ì‘ì„±í•˜ë ¤ë©´ <a href="/member/loginForm">ë¡œê·¸ì¸</a>ì´ í•„ìš”í•©ë‹ˆë‹¤.</p>
	        </div>
	
	        <!-- ë¦¬ë·° ë¦¬ìŠ¤íŠ¸ -->
	        <ul id="review-list">
	            <!-- AJAXë¡œ ë¶ˆëŸ¬ì˜¨ ë¦¬ë·°ë“¤ì´ ì—¬ê¸°ì— ì¶”ê°€ë¨ -->
	        </ul>
	    </div>
	</div>


	<!--  footer -->
	<div id="footer-container">
		<div th:replace="~{layouts/footer}"></div>
	</div>

<script th:inline="javascript">
let sessionUserId = '';
let moviecode = '';

function loadReviews() {
    $.ajax({
        url: `/movieinfo/review?moviecode=${moviecode}&start=1&end=100`,
        type: "GET",
        success: function (reviews) {
            $("#review-list").html("");
            $("#review-count").text(reviews.length);
            
            let myReviewHtml = "";
            let otherReviewsHtml = "";

            reviews.forEach(function (r) {
                let gradeImage = '';
                if (r.grade === 'vvip') gradeImage = '/gradeimage/vvip.jpg';
                else if (r.grade === 'vip') gradeImage = '/gradeimage/vip.jpg';
                else if (r.grade === 'gold') gradeImage = '/gradeimage/gold.jpg';
                else if (r.grade === 'silver') gradeImage = '/gradeimage/silver.jpg';
                else gradeImage = '/gradeimage/basic.jpg';

                const isMyReview = r.user_id === sessionUserId;

                const reviewHtml = `
                    <li class="review-item">
                        <div class="review-profile">
                            <img src="${gradeImage}" alt="ë“±ê¸‰ì´ë¯¸ì§€">
                        </div>
                        <div class="review-content">
                            <div class="review-meta">
                                <strong>${r.user_id}</strong> | ${r.logtime}
                                ${isMyReview ? '<span class="badge bg-secondary">ë‚˜ì˜ë¦¬ë·°</span>' : ''}
                            </div>
                            <div class="review-text">${r.review_comment} (â­ ${r.rating}/10)</div>
                            ${isMyReview ? `
                                <div style="margin-top: 5px;">
                                    <button class="edit-review-btn btn btn-sm btn-outline-primary" data-id="${r.reviewcode}">í¸ì§‘</button>
                                    <button class="delete-review-btn btn btn-sm btn-outline-danger" data-id="${r.reviewcode}">ì‚­ì œ</button>
                                </div>
                            ` : ''}
                        </div>
                        <div class="review-like">
                            ğŸ‘ <span>0</span>
                        </div>
                    </li>
                `;

                if (isMyReview) {
                    myReviewHtml = reviewHtml;
                } else {
                    otherReviewsHtml += reviewHtml;
                }
            });

            $("#review-list").html(myReviewHtml + otherReviewsHtml);
        },
        error: function () {
            alert("ë¦¬ë·°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        }
    });
}

$(document).ready(function () {

    sessionUserId = /*[[${sessionMemid}]]*/ '';
    moviecode = /*[[${movie_info.moviecode}]]*/ 1;

    $(".tab").click(function () {
        $(".tab").removeClass("active");
        $(this).addClass("active");

        if ($(this).attr("id") === "review-tab") {
            $("#tab-content").show();
            $("#detail-section").hide();
            loadReviews();
        } else {
            $("#tab-content").hide();
        }
    });

    $("#detail-tab").click(function () {
        $(".tab").removeClass("active");
        $(this).addClass("active");
        $("#tab-content").hide();
        $("#detail-section").show();
        const info = /*[[${movie_info}]]*/ null;
        const html = `
            <h4 style="margin-top: 30px; font-weight: bold;">ì˜í™”ì •ë³´</h4>
            <p><strong>ì¥ë¥´:</strong> ${info.genre}</p>
            <p><strong>ê°ë…:</strong> ${info.director}</p>
            <p><strong>ì¶œì—°:</strong> ${info.actors}</p>
            <p><strong>ì œì‘êµ­ê°€:</strong> ${info.country}</p>
            <p><strong>ìƒì˜ë“±ê¸‰:</strong> ${info.agerating}ì„¸ ì´ìƒ ê´€ëŒê°€</p>
            <p><strong>ê°œë´‰ì¼:</strong> ${info.releasedate}</p>
            <p><strong>ì¬ìƒì‹œê°„:</strong> ${info.runningtime}ë¶„</p>
            <p><strong>ëˆ„ì  ê´€ê°ìˆ˜:</strong> ${info.total}ëª…</p>
        `;
        $("#detail-section").html(html);
    });

    $("#submit-review-btn").click(function () {
        const ratingVal = parseInt($("#rating").val());

        // ìˆ«ìê°€ ì•„ë‹ˆê±°ë‚˜ ë²”ìœ„(1~10)ë¥¼ ë²—ì–´ë‚œ ê²½ìš°
        if (isNaN(ratingVal) || ratingVal < 1 || ratingVal > 10) {
            alert("ë³„ì ì€ 1ë¶€í„° 10 ì‚¬ì´ì˜ ìˆ«ìë§Œ ì…ë ¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
            $("#rating").val("");
            return;
        }
        
        $.ajax({
            url: `/movieinfo/review/check?moviecode=${moviecode}`,
            type: "GET",
            success: function (exists) {
                if (exists) {
                    alert("ì´ë¯¸ ë¦¬ë·°ë¥¼ ì‘ì„±í•˜ì…¨ìŠµë‹ˆë‹¤.");
                    return;
                }
                const review = {
                    moviecode: moviecode,
                    user_id: sessionUserId,
                    review_comment: $("#comment").val(),
                    rating: $("#rating").val()
                };
                $.ajax({
                    url: "/movieinfo/review",
                    type: "POST",
                    contentType: "application/json",
                    data: JSON.stringify(review),
                    success: function () {
                        $("#comment").val("");
                        $("#rating").val("");
                        loadReviews();
                    }
                });
            }
        });
    });

    $("#detail-tab").click();
});

//ì‚­ì œ ë²„íŠ¼ ì´ë²¤íŠ¸
$(document).on('click', '.delete-review-btn', function () {
    const reviewcode = $(this).data('id');
    if (confirm("ë¦¬ë·°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
        $.ajax({
            url: `/movieinfo/review/${reviewcode}`,
            type: "DELETE",
            success: function () {
                alert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                loadReviews(); // âœ… ì¶”ê°€
            },
            error: function () {
                alert("ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            }
        });
    }
});

//ìˆ˜ì • ë²„íŠ¼ ì´ë²¤íŠ¸
$(document).on('click', '.edit-review-btn', function () {
    const reviewcode = $(this).data('id');
    const newComment = prompt("ìˆ˜ì •í•  ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”:");
    const newRating = prompt("ìˆ˜ì •í•  ë³„ì ì„ ì…ë ¥í•˜ì„¸ìš” (1~10):");

    if (newComment && newRating) {
        $.ajax({
            url: `/movieinfo/review/${reviewcode}`,
            type: "PUT",
            contentType: "application/json",
            data: JSON.stringify({ review_comment: newComment, rating: newRating }),
            success: function () {
                alert("ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
                loadReviews(); // âœ… ì¶”ê°€
            },
            error: function () {
                alert("ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            }
        });
    }
});

//ë¦¬ë·° textareaì— ì…ë ¥í•  ë•Œë§ˆë‹¤ ê¸€ììˆ˜ ì‹¤ì‹œê°„ í‘œì‹œ
$(document).on('input', '#comment', function(){
    let currentLength = $(this).val().length; // í˜„ì¬ ì…ë ¥ëœ ê¸€ì ìˆ˜
    $('#char-count-num').text(currentLength); // ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸
});
</script>


</body>
</html>

