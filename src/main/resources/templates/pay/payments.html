<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<title>ì˜í™” ì˜ˆë§¤ ê²°ì œ</title>

<!-- í† ìŠ¤í˜ì´ë¨¼ì¸  ìŠ¤íƒ€ì¼ ì¶”ê°€ -->
<link rel="stylesheet" href="https://js.tosspayments.com/v2/payment-widget/payment-widget.css" />
<script src="https://js.tosspayments.com/v2/standard"></script>

<style>
body {
    background-color: #f5f8ff;
    font-family: Arial, sans-serif;
    display: flex;
    justify-content: center;
    align-items: center;
    flex-direction: column;
    padding-top: 50px;
}

.wrapper {
    background-color: #fff;
    border-radius: 12px;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    width: 500px;
    padding: 20px;
    box-sizing: border-box;
}

#payment-button {
    background-color: #3182f6;
    border: none;
    color: white;
    padding: 10px;
    width: 100%;
    font-size: 16px;
    cursor: pointer;
    border-radius: 8px;
    margin-top: 20px;
}

.checkable {
    margin-top: 10px;
}
</style>
</head>

<body>
    <div class="wrapper">
        <h2>ì˜í™” ì˜ˆë§¤ ê²°ì œ</h2>
        <p><strong>ê²°ì œ ê¸ˆì•¡:</strong> <span id="final-amount">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</span></p>
        <div id="payment-method"></div>
        <div id="agreement"></div>
        <div class="checkable">
            <label for="coupon-box"> 
                <input id="coupon-box" type="checkbox" /> <span>5,000ì› ì¿ í° ì ìš©</span>
            </label>
        </div>
        <button id="payment-button">ê²°ì œí•˜ê¸°</button>
    </div>

    <script>
    async function main() {
        const urlParams = new URLSearchParams(window.location.search);
        const bookingId = urlParams.get("bookingId");

        if (!bookingId) {
            alert("âŒ ì˜ˆì•½ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. (bookingId ì—†ìŒ)");
            console.error("âŒ bookingId ì—†ìŒ");
            return;
        }

        console.log("ğŸ“Œ ê°€ì ¸ì˜¨ bookingId:", bookingId);

        let amountValue = 0;
        let orderId = null;

        try {
            // âœ… ì˜ˆì•½ ì •ë³´ì—ì„œ orderId ê°€ì ¸ì˜¤ê¸°
            console.log("ğŸ“Œ ì„œë²„ì— bookingId ìš”ì²­: ", bookingId);
            const orderResponse = await fetch(`/api/booking/orderId?bookingId=${bookingId}`);
            if (!orderResponse.ok) throw new Error("orderIdë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            const orderData = await orderResponse.json();
            orderId = orderData.orderId;

            if (!orderId) throw new Error("orderIdê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
            console.log("âœ… ê°€ì ¸ì˜¨ orderId:", orderId);
        } catch (error) {
            console.error("âŒ orderId ë¡œë”© ì‹¤íŒ¨:", error);
            alert("ì˜ˆì•½ ì •ë³´ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
            return;
        }

        try {
            // âœ… ê²°ì œ ê¸ˆì•¡ ê°€ì ¸ì˜¤ê¸°
            console.log("ğŸ“Œ ì„œë²„ì— ê²°ì œ ê¸ˆì•¡ ìš”ì²­: bookingId =", bookingId);
            const response = await fetch(`/api/booking/price?bookingId=${bookingId}`);
            if (!response.ok) throw new Error("ê²°ì œ ê¸ˆì•¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");

            const data = await response.json();
            if (!data.price || isNaN(data.price)) {
                throw new Error("ì„œë²„ì—ì„œ ì˜¬ë°”ë¥¸ ê°€ê²© ë°ì´í„°ë¥¼ ë°˜í™˜í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
            }

            amountValue = Number(data.price);
            console.log("âœ… ìµœì¢… ê²°ì œ ê¸ˆì•¡:", amountValue, typeof amountValue);

            // âœ… í™”ë©´ì— ê²°ì œ ê¸ˆì•¡ í‘œì‹œ
            document.getElementById("final-amount").textContent = amountValue.toLocaleString() + "ì›";
        } catch (error) {
            console.error("âŒ ê²°ì œ ê°€ê²© ë¡œë”© ì‹¤íŒ¨:", error);
            alert(error.message);
        }

        // âœ… í† ìŠ¤í˜ì´ë¨¼ì¸  ê²°ì œ ìœ„ì ¯ ì„¤ì •
        const clientKey = "test_gck_docs_Ovk5rk1EwkEbP0W43n07xlzm";
        const tossPayments = TossPayments(clientKey);
        const widgets = tossPayments.widgets({ customerKey: orderId });

        try {
            await widgets.setAmount({ currency: "KRW", value: amountValue });
        } catch (error) {
            console.error("âŒ setAmount() í˜¸ì¶œ ì‹¤íŒ¨:", error);
        }

        await widgets.renderPaymentMethods({ selector: "#payment-method", variantKey: "DEFAULT" });
        await widgets.renderAgreement({ selector: "#agreement", variantKey: "AGREEMENT" });

        document.getElementById("payment-button").addEventListener("click", async function () {
            try {
                await widgets.requestPayment({
                    orderId: orderId,
                    orderName: "ì˜í™” ì˜ˆë§¤",
                    successUrl: window.location.origin + "/success.html",
                    failUrl: window.location.origin + "/fail.html",
                    customerEmail: "customer123@gmail.com",
                    customerName: "ê¹€í† ìŠ¤",
                    customerMobilePhone: "01012341234",
                });
            } catch (error) {
                console.error("âŒ requestPayment() í˜¸ì¶œ ì‹¤íŒ¨:", error);
            }
        });

        // âœ… ì¿ í° ì ìš© ê¸°ëŠ¥ ì¶”ê°€
        document.getElementById("coupon-box").addEventListener("change", async function () {
            const discount = this.checked ? 5000 : 0;
            const newAmount = Math.max(0, amountValue - discount);
            console.log("âœ… ì¿ í° ì ìš© í›„ amount ê°’:", newAmount);

            try {
                await widgets.setAmount({ currency: "KRW", value: newAmount });
                document.getElementById("final-amount").textContent = newAmount.toLocaleString() + "ì›";
            } catch (error) {
                console.error("âŒ ì¿ í° ì ìš© í›„ setAmount() í˜¸ì¶œ ì‹¤íŒ¨:", error);
            }
        });
    }

    main();
    </script>
</body>
</html>

